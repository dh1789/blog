# Epic 12.0 - WordPress 미디어 라이브러리 자동 통합

**작성일**: 2025-11-04
**Epic 번호**: 12.0
**예상 기간**: 1-2일
**우선순위**: ⭐⭐⭐⭐⭐ (최우선)

---

## 1. 개요 (Introduction/Overview)

현재 블로그 콘텐츠 작성 시 로컬 이미지(`./images/screenshot.png`)를 마크다운에 포함하면, WordPress 발행 전에 수동으로 미디어 라이브러리에 업로드하고 URL을 변경해야 하는 번거로움이 있습니다.

**Epic 12.0**은 이 과정을 완전히 자동화하여 `blog publish` 명령어 실행 시 로컬 이미지를 자동으로 WordPress 미디어 라이브러리에 업로드하고, 마크다운 내 이미지 URL을 WordPress URL로 자동 변환하는 기능을 제공합니다.

### 문제점
```markdown
# Before (수동)
1. 마크다운 작성: ![설명](./images/screenshot.png)
2. WordPress 관리자 → 미디어 업로드
3. URL 복사: https://beomanro.com/wp-content/uploads/2025/11/screenshot.png
4. 마크다운 수정: ![설명](https://beomanro.com/...)
5. blog publish 실행

→ 이미지 1개당 5-10분 소요
→ URL 변경 누락 시 이미지 깨짐
```

### 해결책
```bash
# After (자동)
blog publish content/posts/ko/my-post.md --upload-images

# 자동 처리:
# 1. 마크다운에서 로컬 이미지 경로 파싱
# 2. WordPress 미디어 REST API로 업로드
# 3. 마크다운 URL 자동 변환
# 4. WordPress 발행

→ 이미지 처리 시간 100% 절감 (0분)
→ URL 변경 실수 방지
```

---

## 2. 목표 (Goals)

1. **이미지 처리 완전 자동화**: 로컬 이미지를 WordPress 미디어 라이브러리에 자동 업로드
2. **워크플로우 간소화**: 마크다운 작성 → 발행의 단일 단계로 통합
3. **실수 방지**: URL 변경 누락으로 인한 이미지 깨짐 방지
4. **중복 방지**: 이미 업로드된 이미지 재업로드 방지 (성능 최적화)
5. **개발자 경험 향상**: CLI 플래그 하나로 기능 활성화 (`--upload-images`)

---

## 3. 사용자 스토리 (User Stories)

### US-12.1: 이미지 자동 업로드
**As a** 블로거
**I want to** 로컬 이미지가 포함된 마크다운을 작성하고 `blog publish`만 실행하면
**So that** 이미지가 자동으로 WordPress에 업로드되고 URL이 변환되어 시간을 절약할 수 있다

**Acceptance Criteria**:
- [x] `./images/screenshot.png` 같은 상대 경로 이미지 파싱
- [x] WordPress 미디어 REST API로 자동 업로드
- [x] 업로드된 이미지 URL로 마크다운 자동 변환
- [x] 변환된 콘텐츠로 WordPress 포스트 발행

---

### US-12.2: 중복 이미지 감지
**As a** 블로거
**I want to** 같은 이미지를 재발행할 때 중복 업로드를 방지하고
**So that** 미디어 라이브러리가 깔끔하게 유지되고 업로드 속도가 빨라진다

**Acceptance Criteria**:
- [x] 파일명 기반 중복 감지 (WordPress 미디어 라이브러리 검색)
- [x] 이미 업로드된 이미지는 재사용 (URL 조회)
- [x] 신규 이미지만 업로드

---

### US-12.3: 외부 이미지 URL 보존
**As a** 블로거
**I want to** 이미 https:// 로 시작하는 외부 이미지 URL은 그대로 유지하고
**So that** CDN이나 외부 호스팅 이미지를 계속 사용할 수 있다

**Acceptance Criteria**:
- [x] https:// 또는 http:// 로 시작하는 URL은 업로드 대상에서 제외
- [x] 외부 URL은 그대로 WordPress 콘텐츠에 포함

---

### US-12.4: 에러 처리
**As a** 블로거
**I want to** 이미지 업로드 실패 시 명확한 에러 메시지를 보고
**So that** 어떤 이미지가 문제인지 파악하고 수동으로 처리할 수 있다

**Acceptance Criteria**:
- [x] 업로드 실패 시 파일명과 에러 이유 출력
- [x] 일부 이미지 실패해도 나머지 처리 계속 진행
- [x] 최종 리포트: 성공/실패 개수 및 실패 이미지 목록

---

## 4. 기능 요구사항 (Functional Requirements)

### FR-12.1: 이미지 경로 파싱
**요구사항**: 마크다운 콘텐츠에서 모든 이미지 경로를 추출한다.

**상세**:
- `![alt text](./path/to/image.png)` 패턴 파싱
- `![](../images/screenshot.jpg)` 같은 상대 경로 지원
- `<img src="./image.png">` HTML 이미지 태그도 파싱 (optional)

**우선순위**: P0 (필수)

---

### FR-12.2: WordPress 미디어 REST API 클라이언트
**요구사항**: WordPress REST API의 `/wp/v2/media` 엔드포인트를 사용하여 이미지를 업로드한다.

**상세**:
```typescript
// packages/core/src/media.ts
class WordPressMediaClient {
  /**
   * 이미지 파일을 WordPress 미디어 라이브러리에 업로드
   *
   * @param filePath - 로컬 이미지 파일 경로
   * @returns 업로드된 이미지의 WordPress URL 및 ID
   */
  async uploadImage(filePath: string): Promise<{
    id: number;
    url: string;
    source_url: string;
  }>;

  /**
   * 파일명으로 미디어 라이브러리 검색 (중복 체크용)
   *
   * @param filename - 파일명 (예: "screenshot.png")
   * @returns 이미 업로드된 이미지 정보 또는 null
   */
  async findMediaByFilename(filename: string): Promise<MediaItem | null>;
}
```

**API 엔드포인트**:
- `POST /wp/v2/media` - 이미지 업로드
- `GET /wp/v2/media?search={filename}` - 중복 체크

**인증**: WordPress Application Password (기존 WordPressClient와 동일)

**우선순위**: P0 (필수)

---

### FR-12.3: 이미지 URL 자동 변환
**요구사항**: 파싱된 로컬 이미지 경로를 WordPress URL로 변환한다.

**상세**:
```typescript
// Before
![스크린샷](./images/screenshot.png)

// After (자동 변환)
![스크린샷](https://beomanro.com/wp-content/uploads/2025/11/screenshot.png)
```

**변환 로직**:
1. 로컬 경로 파싱: `./images/screenshot.png`
2. 절대 경로 해석: `/Users/idongho/proj/blog/content/posts/ko/images/screenshot.png`
3. 파일 존재 확인: `fs.existsSync()`
4. WordPress 업로드: `uploadImage()`
5. URL 변환: `![스크린샷](https://beomanro.com/...)`

**우선순위**: P0 (필수)

---

### FR-12.4: 중복 이미지 감지 및 재사용
**요구사항**: 동일한 파일명의 이미지가 이미 미디어 라이브러리에 있으면 재업로드하지 않는다.

**상세**:
```typescript
// 중복 체크 로직
const existingMedia = await mediaClient.findMediaByFilename('screenshot.png');
if (existingMedia) {
  // 기존 URL 재사용
  return existingMedia.source_url;
} else {
  // 신규 업로드
  return await mediaClient.uploadImage(filePath);
}
```

**우선순위**: P1 (중요)

---

### FR-12.5: CLI 플래그 지원
**요구사항**: `blog publish` 명령어에 `--upload-images` 플래그 추가.

**상세**:
```bash
# 이미지 자동 업로드 활성화
blog publish content/posts/ko/my-post.md --upload-images

# 기본 동작 (이미지 업로드 안 함)
blog publish content/posts/ko/my-post.md
```

**구현 위치**: `packages/cli/src/commands/publish.ts`

**우선순위**: P0 (필수)

---

### FR-12.6: 에러 처리 및 리포트
**요구사항**: 이미지 업로드 실패 시 명확한 에러 메시지와 최종 리포트 제공.

**상세**:
```
✅ 이미지 업로드 완료:
  ✓ screenshot.png → https://beomanro.com/wp-content/uploads/2025/11/screenshot.png
  ✓ diagram.jpg → https://beomanro.com/wp-content/uploads/2025/11/diagram.jpg

❌ 이미지 업로드 실패:
  ✗ missing.png - 파일을 찾을 수 없습니다
  ✗ large-file.jpg - 파일 크기 초과 (최대 10MB)

📊 최종 리포트:
  - 총 이미지: 4개
  - 성공: 2개
  - 중복 재사용: 0개
  - 실패: 2개
```

**우선순위**: P1 (중요)

---

## 5. 비기능 요구사항 (Non-Goals / Out of Scope)

❌ **이미지 최적화**: WebP 변환, 압축, 리사이징은 Epic 13.0에서 구현
❌ **반응형 이미지**: srcset 생성은 Epic 13.0에서 구현
❌ **AI Alt 텍스트**: 자동 alt 텍스트 생성은 Epic 13.0에서 구현
❌ **비디오/오디오**: 이미지 외 미디어는 향후 Epic에서 구현
❌ **외부 이미지 다운로드**: https:// URL의 이미지는 다운로드하지 않음

---

## 6. 설계 고려사항 (Design Considerations)

### 6.1 아키텍처
```
packages/
├── core/src/
│   ├── media.ts              # NEW: WordPress 미디어 API 클라이언트
│   ├── markdown.ts           # MODIFY: 이미지 경로 파싱 추가
│   └── wordpress.ts          # 기존 유지
├── cli/src/commands/
│   └── publish.ts            # MODIFY: --upload-images 플래그 추가
└── shared/src/
    ├── types.ts              # MODIFY: MediaItem 타입 추가
    └── schemas.ts            # MODIFY: 미디어 관련 Zod 스키마 추가
```

### 6.2 데이터 흐름
```
1. 마크다운 파일 읽기
   ↓
2. 이미지 경로 파싱 (![](path) 패턴)
   ↓
3. 각 로컬 이미지마다:
   a. 중복 체크 (findMediaByFilename)
   b. 중복이면 기존 URL 사용
   c. 신규면 업로드 (uploadImage)
   d. URL 변환
   ↓
4. 변환된 콘텐츠로 WordPress 발행
```

### 6.3 에러 처리 전략
- **파일 없음**: `fs.existsSync()` 실패 시 경고 출력, 원본 경로 유지
- **업로드 실패**: 네트워크 에러 시 재시도 (최대 3회), 실패 시 원본 경로 유지
- **인증 실패**: WordPress 인증 에러 시 즉시 중단, 사용자에게 설정 확인 요청

---

## 7. 기술 고려사항 (Technical Considerations)

### 7.1 WordPress REST API 엔드포인트
```bash
# 이미지 업로드
POST https://beomanro.com/wp-json/wp/v2/media
Headers:
  Authorization: Basic {base64(username:app_password)}
  Content-Type: image/png
Body: (binary image data)

Response:
{
  "id": 123,
  "source_url": "https://beomanro.com/wp-content/uploads/2025/11/screenshot.png",
  "media_details": {
    "width": 1920,
    "height": 1080,
    "file": "2025/11/screenshot.png"
  }
}

# 중복 체크
GET https://beomanro.com/wp-json/wp/v2/media?search=screenshot.png
```

### 7.2 의존성
- **기존 라이브러리**:
  - `wpapi`: WordPress REST API 클라이언트 (이미 사용 중)
  - `gray-matter`: 마크다운 frontmatter 파싱 (이미 사용 중)
  - `unified` + `remark`: 마크다운 파싱 (이미 사용 중)

- **신규 라이브러리 필요 없음**: 기존 Node.js `fs`, `path` 모듈로 충분

### 7.3 성능 고려사항
- **병렬 업로드**: `Promise.all()`로 여러 이미지 동시 업로드 (최대 5개)
- **중복 체크 캐싱**: 세션 내에서 업로드 결과 캐싱하여 중복 API 호출 방지
- **파일 크기 제한**: 10MB 이상 이미지는 경고 출력 (WordPress 기본 제한)

### 7.4 보안 고려사항
- **경로 검증**: `..` 같은 경로 순회 공격 방지 (`path.resolve()`)
- **파일 타입 검증**: 이미지 파일만 업로드 허용 (MIME 타입 체크)
- **인증 재사용**: 기존 WordPressClient의 Application Password 사용

---

## 8. 테스트 요구사항 (Testing Requirements)

### 8.1 단위 테스트 (Unit Tests)
**프레임워크**: Vitest

#### Test Suite 1: `media.test.ts` - WordPressMediaClient
```typescript
describe('WordPressMediaClient', () => {
  // Happy Path
  it('should upload a new image successfully', async () => {
    const client = new WordPressMediaClient(config);
    const result = await client.uploadImage('./test/fixtures/image.png');
    expect(result.url).toMatch(/https:\/\/.*\.png$/);
    expect(result.id).toBeGreaterThan(0);
  });

  // Boundary Conditions
  it('should handle large file (10MB)', async () => {
    // 10MB 파일 업로드 테스트
  });

  it('should handle empty file', async () => {
    // 빈 파일 업로드 시 에러
  });

  // Exception Cases
  it('should throw error on invalid file path', async () => {
    await expect(client.uploadImage('./nonexistent.png'))
      .rejects.toThrow('File not found');
  });

  it('should throw error on authentication failure', async () => {
    // 잘못된 인증 정보로 업로드 시 에러
  });

  // Side Effects
  it('should not affect other tests (cleanup)', async () => {
    // 테스트 간 격리 확인
  });
});

describe('findMediaByFilename', () => {
  it('should find existing media', async () => {
    // 중복 이미지 찾기 테스트
  });

  it('should return null for non-existent media', async () => {
    // 존재하지 않는 이미지 검색
  });
});
```

#### Test Suite 2: `markdown.test.ts` - 이미지 경로 파싱
```typescript
describe('parseImagePaths', () => {
  // Happy Path
  it('should parse relative image paths', () => {
    const content = '![alt](./images/test.png)';
    const paths = parseImagePaths(content);
    expect(paths).toEqual(['./images/test.png']);
  });

  // Boundary Conditions
  it('should handle multiple images', () => {
    const content = '![a](./a.png) ![b](./b.jpg)';
    expect(parseImagePaths(content)).toHaveLength(2);
  });

  it('should handle empty content', () => {
    expect(parseImagePaths('')).toEqual([]);
  });

  // Exception Cases
  it('should ignore external URLs', () => {
    const content = '![ext](https://example.com/image.png)';
    expect(parseImagePaths(content)).toEqual([]);
  });
});
```

### 8.2 시스템 테스트 (System Tests)
**프레임워크**: E2E 테스트 (실제 WordPress 연동)

#### System Test 1: 신규 이미지 자동 업로드
**시나리오**: 로컬 이미지가 포함된 마크다운 발행

**준비**:
```bash
# 테스트 마크다운 생성
content/posts/ko/test-image-upload.md
---
title: "이미지 업로드 테스트"
---
![테스트 이미지](./images/test-screenshot.png)
```

**실행**:
```bash
blog publish content/posts/ko/test-image-upload.md --upload-images
```

**검증**:
1. 이미지가 WordPress 미디어 라이브러리에 업로드됨 (API 확인)
2. 포스트 콘텐츠에 WordPress URL이 포함됨
3. 실제 포스트 페이지에서 이미지 정상 표시

---

#### System Test 2: 중복 이미지 재사용
**시나리오**: 이미 업로드된 이미지를 재발행

**준비**:
```bash
# 동일한 이미지를 포함한 다른 포스트
content/posts/ko/test-duplicate-image.md
---
title: "중복 이미지 테스트"
---
![동일 이미지](./images/test-screenshot.png)
```

**실행**:
```bash
blog publish content/posts/ko/test-duplicate-image.md --upload-images
```

**검증**:
1. 이미지 재업로드 안 됨 (미디어 라이브러리 개수 증가 안 함)
2. 기존 이미지 URL 재사용됨
3. 로그에 "중복 재사용: 1개" 표시

---

## 9. 성공 지표 (Success Metrics)

### 정량적 지표
- ✅ **이미지 처리 시간**: 수동 5-10분 → 자동 0분 (100% 절감)
- ✅ **워크플로우 단계**: 5단계 → 1단계 (80% 감소)
- ✅ **이미지 URL 오류율**: 수동 10-20% → 자동 0% (완전 방지)
- ✅ **테스트 커버리지**: 신규 코드 90% 이상

### 정성적 지표
- ✅ **개발자 경험**: 플래그 하나로 간편하게 활성화
- ✅ **신뢰성**: 에러 발생 시 명확한 메시지와 리포트
- ✅ **유지보수성**: 기존 코드와 분리된 media.ts 모듈

---

## 10. 미해결 질문 (Open Questions)

1. **이미지 파일명 중복 처리**: 동일 파일명이지만 내용이 다른 경우 어떻게 처리?
   - **제안**: 파일 해시(MD5) 비교로 실제 중복 여부 확인

2. **대용량 이미지 처리**: 10MB 이상 이미지는 업로드 전 압축?
   - **제안**: Epic 13.0에서 이미지 최적화와 함께 구현

3. **프로그레스 바**: 여러 이미지 업로드 시 진행률 표시?
   - **제안**: `ora` 스피너로 간단하게 표시, 상세 진행률은 Epic 14.0에서 구현

4. **외부 URL 다운로드**: https:// 이미지를 로컬에 다운로드할지?
   - **제안**: 현재 버전에서는 Non-Goal, 향후 Epic에서 옵션으로 추가 고려

---

## 11. Task 분해 (Epic 12.0 → Tasks)

### Task 12.1: WordPress Media API 클라이언트 구현 (0.5일)
- [ ] `packages/core/src/media.ts` 생성
- [ ] `WordPressMediaClient` 클래스 구현
- [ ] `uploadImage()` 메서드 구현
- [ ] `findMediaByFilename()` 메서드 구현
- [ ] 단위 테스트 작성 (`media.test.ts`)

### Task 12.2: 이미지 경로 파싱 및 변환 (0.5일)
- [ ] `packages/core/src/markdown.ts`에 `parseImagePaths()` 함수 추가
- [ ] `replaceImageUrls()` 함수 구현 (로컬 경로 → WordPress URL)
- [ ] 절대 경로 변환 로직 구현 (`path.resolve()`)
- [ ] 단위 테스트 작성 (`markdown.test.ts`)

### Task 12.3: CLI 통합 및 E2E 테스트 (0.5일)
- [ ] `packages/cli/src/commands/publish.ts`에 `--upload-images` 플래그 추가
- [ ] 이미지 업로드 → URL 변환 → 발행 워크플로우 통합
- [ ] 에러 처리 및 리포트 출력 구현
- [ ] E2E 테스트 2개 작성 (신규 업로드, 중복 재사용)
- [ ] 문서 업데이트 (README.md, CLAUDE.md)

---

**최종 업데이트**: 2025-11-04
**작성자**: Claude Code
**검토자**: (사용자 검토 필요)
